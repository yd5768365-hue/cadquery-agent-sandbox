# 🚀 CAE 自动化平台完整部署指南

## 📋 系统需求

### 硬件要求
- **CPU**: 8 核心或更多（推荐）
- **内存**: 16GB RAM（最低），32GB 推荐
- **硬盘**: 100GB 可用空间
- **GPU**: 可选（用于深度学习加速）

### 软件要求
- **操作系统**: Windows 10/11, Linux, macOS
- **Docker Desktop**: 最新版本
- **Python**: 3.10 或更高
- **Git**: 用于版本控制（可选）

---

## 🎯 快速部署（20 分钟）

### 步骤 1：准备环境（5 分钟）

```powershell
# 1. 确认 Docker 已安装并运行
docker --version
docker-compose --version

# 2. 确认 Python 已安装
python --version

# 3. 创建项目根目录
cd E:\
mkdir DeepSeek_Work
cd DeepSeek_Work
```

### 步骤 2：下载代码（3 分钟）

将所有 artifacts 中的代码文件保存到对应目录：

```
E:\DeepSeek_Work\
├── docker/
│   ├── docker-compose.yml          # 已提供
│   ├── gmsh.Dockerfile            # 已提供
│   ├── calculix.Dockerfile        # 已提供
│   ├── ml.Dockerfile              # 已提供
│   ├── visualize.Dockerfile       # 已提供
│   └── server.Dockerfile          # 已提供
│
├── server/
│   ├── server.py                  # 需要更新（集成所有模块）
│   ├── tasks.py                   # 已提供
│   └── data_collector.py          # 已提供
│
├── ml/
│   ├── models/
│   │   ├── surrogate_model.py     # 已提供
│   │   ├── geometry_encoder.py    # 已提供
│   │   ├── geometry_search.py     # 已提供
│   │   └── prediction_engine.py   # 已提供
│   └── trainers/
│       ├── train_surrogate.py     # 已提供
│       └── train_geometry.py      # 已提供
│
├── services/
│   └── viz_service.py             # 已提供
│
├── dashboard/
│   ├── app.py                     # 已提供
│   └── Dockerfile                 # 已提供
│
├── scripts/
│   ├── setup.sh                   # 已提供
│   ├── start_all.sh               # 已提供
│   ├── stop_all.sh                # 已提供
│   └── health_check.sh            # 已提供
│
├── config/
│   └── celery_config.py           # 已提供
│
└── requirements.txt               # 已提供
```

### 步骤 3：安装依赖（5 分钟）

```powershell
# 安装 Python 依赖
cd E:\DeepSeek_Work
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 步骤 4：一键部署（7 分钟）

#### Windows PowerShell:
```powershell
cd E:\DeepSeek_Work\docker
docker-compose up -d
```

#### Linux/Mac:
```bash
cd E:/DeepSeek_Work
chmod +x scripts/*.sh
./scripts/setup.sh
```

### 步骤 5：验证部署

```powershell
# 检查所有容器状态
docker ps

# 应该看到以下容器运行：
# - cae_redis
# - cae_postgres
# - cae_gmsh
# - cae_calculix
# - cae_ml
# - cae_visualize
# - cae_celery_worker
# - cae_celery_beat
# - cae_flower
# - cae_dashboard
```

访问以下地址验证：
- 🎨 **仪表盘**: http://localhost:8501
- 🌸 **Celery 监控**: http://localhost:5555

---

## 🔧 详细配置

### 配置 1：数据库连接

编辑 `config/database_config.py`:

```python
DATABASE_URL = "postgresql://cae_user:cae_pass_2024@postgres:5432/cae_platform"
REDIS_URL = "redis://redis:6379/0"
```

### 配置 2：Celery 任务队列

编辑 `config/celery_config.py`:

```python
broker_url = 'redis://redis:6379/0'
result_backend = 'redis://redis:6379/0'

# 根据 CPU 核心数调整
worker_concurrency = 8  # 改为你的 CPU 核心数
```

### 配置 3：Docker 资源限制

编辑 `docker/docker-compose.yml`:

```yaml
calculix-service:
  # ...
  deploy:
    resources:
      limits:
        cpus: '8'        # 根据你的 CPU 调整
        memory: 16G      # 根据你的内存调整
```

### 配置 4：工作目录挂载

确保工作目录正确挂载：

```yaml
volumes:
  - E:/DeepSeek_Work/test:/app  # Windows
  # - /home/user/DeepSeek_Work/test:/app  # Linux/Mac
```

---

## 🎮 使用指南

### 1. 启动系统

```powershell
# 启动所有服务
cd E:\DeepSeek_Work\docker
docker-compose up -d

# 启动 MCP 服务器
cd E:\DeepSeek_Work
python server/server.py
```

### 2. 访问仪表盘

打开浏览器访问 http://localhost:8501

### 3. 配置 Cherry Studio

在 Cherry Studio 中配置 MCP 服务器：

```
命令: python
参数: E:\DeepSeek_Work\server\server.py
工作目录: E:\DeepSeek_Work
```

### 4. 第一次运行

**在 Cherry Studio 中测试：**

```
你: "测试系统连接"

AI: [调用各种工具确认系统正常]
```

**在仪表盘中：**

1. 打开 http://localhost:8501
2. 查看"实时监控"页面
3. 确认所有指标正常

---

## 📊 功能使用示例

### 示例 1：运行完整分析

**在 Cherry Studio 中：**

```
你: "分析 test/input/bracket.step，生成网格并运行应力分析"

AI 会自动：
1. 调用 data_collector 开始记录
2. 检查是否有相似历史案例（几何向量搜索）
3. 如果没有，调用代理模型预测
4. 如果置信度低，运行完整仿真
5. 生成可视化云图
6. 将结果存入数据库
```

### 示例 2：批量参数化研究

**在仪表盘中：**

1. 进入"任务管理"页面
2. 选择"批量提交"标签
3. 设置参数范围：
   - 参数：hole_diameter
   - 范围：5.0 ~ 10.0
   - 步长：0.5
4. 点击"提交批量任务"

**后台自动：**
- 生成 11 个不同参数的任务
- 并行执行（最多 8 个同时）
- 结果实时显示在监控页面

### 示例 3：训练代理模型

**方法 1：手动触发**

```powershell
cd E:\DeepSeek_Work
python ml/trainers/train_surrogate.py
```

**方法 2：定时自动**

系统每天自动训练（Celery Beat 定时任务）

**方法 3：在仪表盘中**

1. 进入"模型管理"页面
2. 点击"重新训练"
3. 等待训练完成

---

## 🔍 监控和维护

### 实时监控

**Celery 任务监控：**
```
访问 http://localhost:5555
查看所有运行中的任务
```

**系统健康检查：**
```bash
./scripts/health_check.sh
```

**查看日志：**
```powershell
# 查看特定服务日志
docker-compose logs -f cae_celery_worker

# 查看所有日志
docker-compose logs -f
```

### 数据备份

**自动备份：**
```bash
# 每周自动备份（可配置 crontab）
./scripts/backup.sh
```

**手动备份：**
```powershell
# 备份数据库
docker exec cae_postgres pg_dump -U cae_user cae_platform > backup.sql

# 备份仿真历史
copy E:\DeepSeek_Work\ml\data\simulation_history.db backup\
```

### 性能优化

**1. 增加 Worker 数量（提升并行度）：**

编辑 `docker-compose.yml`:

```yaml
celery-worker:
  command: celery -A tasks worker --loglevel=info --concurrency=16
```

**2. 启用 GPU 加速（ML 服务）：**

```yaml
ml-service:
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]
```

**3. 调整 Redis 内存：**

```bash
docker exec cae_redis redis-cli CONFIG SET maxmemory 2gb
```

---

## 🐛 故障排查

### 问题 1：容器启动失败

```powershell
# 查看错误日志
docker-compose logs [服务名]

# 常见原因：
# - 端口被占用 → 修改 docker-compose.yml 中的端口
# - 内存不足 → 减少容器资源限制
# - 磁盘空间不足 → 清理 Docker 缓存
```

### 问题 2：任务执行失败

```powershell
# 查看 Celery Worker 日志
docker logs cae_celery_worker

# 检查任务状态
访问 http://localhost:5555
```

### 问题 3：数据库连接失败

```powershell
# 检查 PostgreSQL 状态
docker exec cae_postgres pg_isready

# 重启数据库
docker-compose restart postgres
```

### 问题 4：模型加载失败

```python
# 检查模型文件是否存在
import os
os.path.exists('E:/DeepSeek_Work/ml/models/surrogate_stress.pkl')

# 重新训练模型
python ml/trainers/train_surrogate.py
```

---

## 📈 系统升级

### 升级流程

```bash
# 1. 备份数据
./scripts/backup.sh

# 2. 停止服务
docker-compose down

# 3. 拉取新代码（如果使用 Git）
git pull

# 4. 重建镜像
docker-compose build --no-cache

# 5. 启动服务
docker-compose up -d

# 6. 验证升级
./scripts/health_check.sh
```

---

## 🎯 性能基准

### 预期性能指标

| 操作 | 传统方式 | 平台方式 | 提升 |
|------|---------|---------|------|
| 网格生成 | 5 分钟 | 3 分钟 | 40% |
| 应力分析 | 10 分钟 | 10 分钟 | - |
| 参数变更预测 | 10 分钟 | 10 秒 | 98% |
| 批量 100 个变体 | 1周 | 2 小时 | 99% |
| 错误诊断 | 30 分钟 | 10 秒 | 99% |

### 资源占用

- **Docker 镜像**: ~5GB
- **运行内存**: ~8GB
- **数据库**: ~1GB (10,000 记录)
- **CPU 使用**: 10-80% (取决于并发任务数)

---

## ✅ 部署检查清单

### 基础环境
- [ ] Docker Desktop 已安装并运行
- [ ] Python 3.10+ 已安装
- [ ] 磁盘空间 > 100GB

### 代码文件
- [ ] 所有 Dockerfiles 已创建
- [ ] docker-compose.yml 已配置
- [ ] Python 代码文件已保存
- [ ] 配置文件已创建

### 服务部署
- [ ] 所有容器正常运行 (docker ps)
- [ ] 仪表盘可访问 (http://localhost:8501)
- [ ] Celery 监控可访问 (http://localhost:5555)
- [ ] MCP 服务器可启动

### 功能测试
- [ ] Cherry Studio 可连接 MCP
- [ ] 数据收集系统正常
- [ ] 任务队列正常工作
- [ ] 可视化生成成功
- [ ] 仪表盘显示正常

### 数据初始化
- [ ] 数据库表已创建
- [ ] 至少运行 1 次完整仿真
- [ ] 数据在仪表盘中显示

---

## 🎉 部署完成！

现在你拥有一个**完整的企业级 CAE 自动化平台**！

### 核心能力

✅ **智能预测**: 代理模型快速预测结果  
✅ **并行计算**: Celery 任务队列支持大规模并行  
✅ **几何搜索**: 向量数据库查找相似案例  
✅ **自动可视化**: 一键生成专业云图  
✅ **数字孪生**: 实时监控所有仿真任务  
✅ **数据积累**: 完整记录每次仿真  
✅ **持续学习**: 自动训练优化模型  

