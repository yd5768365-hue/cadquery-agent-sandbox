# dashboard/app.py
"""
æ•°å­—å­ªç”Ÿä»ªè¡¨ç›˜ä¸»ç¨‹åº
ä½¿ç”¨ Streamlit æ„å»ºäº¤äº’å¼ç›‘æ§ç•Œé¢
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import sys
sys.path.append('E:/DeepSeek_Work')

from server.data_collector import SimulationDataCollector
from server.tasks import get_task_status, get_job_progress
from ml.models.surrogate_model import SurrogateModel

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="CAE æ•°å­—å­ªç”Ÿå¹³å°",
    page_icon="ğŸ—ï¸",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ==================== ä¾§è¾¹æ  ====================

st.sidebar.title("ğŸ—ï¸ CAE æ•°å­—å­ªç”Ÿå¹³å°")
st.sidebar.markdown("---")

page = st.sidebar.radio(
    "å¯¼èˆª",
    ["ğŸ“Š å®æ—¶ç›‘æ§", "ğŸ“ˆ æ•°æ®åˆ†æ", "ğŸ¤– æ¨¡å‹ç®¡ç†", "ğŸ¨ å¯è§†åŒ–", "âš™ï¸ ä»»åŠ¡ç®¡ç†"]
)

st.sidebar.markdown("---")
st.sidebar.info("""
**å¹³å°çŠ¶æ€**
- ç‰ˆæœ¬: v1.0.0
- è¿è¡Œæ—¶é—´: è¿è¡Œä¸­
- æ•°æ®åº“: å·²è¿æ¥
""")

# ==================== é¡µé¢1ï¼šå®æ—¶ç›‘æ§ ====================

if page == "ğŸ“Š å®æ—¶ç›‘æ§":
    st.title("ğŸ“Š å®æ—¶ç›‘æ§ä»ªè¡¨ç›˜")
    
    # é¡¶éƒ¨æŒ‡æ ‡å¡ç‰‡
    col1, col2, col3, col4 = st.columns(4)
    
    collector = SimulationDataCollector()
    stats = collector.get_statistics()
    
    with col1:
        st.metric(
            label="æ€»ä»¿çœŸæ•°",
            value=stats.get('total_simulations', 0),
            delta="+5 ä»Šæ—¥"
        )
    
    with col2:
        st.metric(
            label="æˆåŠŸç‡",
            value=f"{(stats.get('successful_simulations', 0) / max(stats.get('total_simulations', 1), 1) * 100):.1f}%",
            delta="+2.3%"
        )
    
    with col3:
        avg_duration = stats.get('avg_duration', 0)
        st.metric(
            label="å¹³å‡è€—æ—¶",
            value=f"{avg_duration/60:.1f} åˆ†é’Ÿ" if avg_duration else "N/A",
            delta="-12%"
        )
    
    with col4:
        st.metric(
            label="è¿è¡Œä¸­ä»»åŠ¡",
            value="2",
            delta="å®æ—¶"
        )
    
    st.markdown("---")
    
    # ä»¿çœŸç±»å‹åˆ†å¸ƒ
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("ğŸ“‹ ä»¿çœŸç±»å‹åˆ†å¸ƒ")
        
        by_type = stats.get('by_type', {})
        if by_type:
            df_type = pd.DataFrame([
                {'ç±»å‹': k, 'æ•°é‡': v} for k, v in by_type.items()
            ])
            
            fig = px.pie(df_type, values='æ•°é‡', names='ç±»å‹', hole=0.4)
            fig.update_layout(height=300)
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("æš‚æ— æ•°æ®")
    
    with col2:
        st.subheader("ğŸ“ˆ æœ€è¿‘7å¤©è¶‹åŠ¿")
        
        # æ¨¡æ‹Ÿæ—¶é—´åºåˆ—æ•°æ®
        dates = pd.date_range(end=datetime.now(), periods=7, freq='D')
        data = {
            'æ—¥æœŸ': dates,
            'ä»¿çœŸæ•°': [12, 15, 18, 14, 20, 22, 25]
        }
        df_trend = pd.DataFrame(data)
        
        fig = px.line(df_trend, x='æ—¥æœŸ', y='ä»¿çœŸæ•°', markers=True)
        fig.update_layout(height=300)
        st.plotly_chart(fig, use_container_width=True)
    
    # æœ€è¿‘ä»¿çœŸè®°å½•
    st.subheader("ğŸ•’ æœ€è¿‘ä»¿çœŸè®°å½•")
    
    training_data = collector.get_training_data(limit=10)
    
    if training_data:
        records = []
        for record in training_data:
            records.append({
                'ä»¿çœŸID': record[0][:8],
                'ç±»å‹': record[1],
                'ç½‘æ ¼å•å…ƒ': record[3] if record[3] else 'N/A',
                'æœ€å¤§åº”åŠ›(MPa)': f"{record[6]:.2f}" if record[6] else 'N/A',
                'çŠ¶æ€': 'âœ… å®Œæˆ'
            })
        
        df_records = pd.DataFrame(records)
        st.dataframe(df_records, use_container_width=True, hide_index=True)
    else:
        st.info("æš‚æ— ä»¿çœŸè®°å½•")

# ==================== é¡µé¢2ï¼šæ•°æ®åˆ†æ ====================

elif page == "ğŸ“ˆ æ•°æ®åˆ†æ":
    st.title("ğŸ“ˆ æ•°æ®åˆ†æ")
    
    collector = SimulationDataCollector()
    
    # åˆ†æç±»å‹é€‰æ‹©
    analysis_type = st.selectbox(
        "é€‰æ‹©åˆ†æç±»å‹",
        ["stress", "thermal", "modal", "å…¨éƒ¨"]
    )
    
    if analysis_type == "å…¨éƒ¨":
        analysis_type = None
    
    # åŠ è½½æ•°æ®
    training_data = collector.get_training_data(analysis_type=analysis_type)
    
    if not training_data:
        st.warning("æš‚æ— æ•°æ®å¯åˆ†æ")
    else:
        st.success(f"å·²åŠ è½½ {len(training_data)} æ¡è®°å½•")
        
        # æå–æ•°æ®
        max_stresses = [r[6] for r in training_data if r[6]]
        mean_stresses = [r[7] for r in training_data if r[7]]
        max_disps = [r[8] for r in training_data if r[8]]
        
        # ç»Ÿè®¡æ‘˜è¦
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric(
                "åº”åŠ›èŒƒå›´",
                f"{min(max_stresses):.1f} - {max(max_stresses):.1f} MPa"
            )
        
        with col2:
            st.metric(
                "å¹³å‡åº”åŠ›",
                f"{sum(mean_stresses)/len(mean_stresses):.1f} MPa"
            )
        
        with col3:
            st.metric(
                "æœ€å¤§ä½ç§»",
                f"{max(max_disps):.4f} mm" if max_disps else "N/A"
            )
        
        st.markdown("---")
        
        # å¯è§†åŒ–
        tab1, tab2, tab3 = st.tabs(["åº”åŠ›åˆ†å¸ƒ", "æ•£ç‚¹çŸ©é˜µ", "ç›¸å…³æ€§åˆ†æ"])
        
        with tab1:
            st.subheader("åº”åŠ›åˆ†å¸ƒç›´æ–¹å›¾")
            
            fig = go.Figure()
            fig.add_trace(go.Histogram(x=max_stresses, name="æœ€å¤§åº”åŠ›", nbinsx=30))
            fig.update_layout(
                xaxis_title="åº”åŠ› (MPa)",
                yaxis_title="é¢‘æ¬¡",
                height=400
            )
            st.plotly_chart(fig, use_container_width=True)
        
        with tab2:
            st.subheader("å‚æ•°æ•£ç‚¹çŸ©é˜µ")
            
            df_scatter = pd.DataFrame({
                'æœ€å¤§åº”åŠ›': max_stresses,
                'å¹³å‡åº”åŠ›': mean_stresses[:len(max_stresses)]
            })
            
            fig = px.scatter(df_scatter, x='æœ€å¤§åº”åŠ›', y='å¹³å‡åº”åŠ›', 
                           trendline="ols", title="åº”åŠ›ç›¸å…³æ€§")
            st.plotly_chart(fig, use_container_width=True)
        
        with tab3:
            st.subheader("æ•°æ®ç›¸å…³æ€§")
            
            if len(max_stresses) > 1:
                correlation = pd.DataFrame({
                    'æœ€å¤§åº”åŠ›': max_stresses,
                    'å¹³å‡åº”åŠ›': mean_stresses[:len(max_stresses)]
                }).corr()
                
                fig = px.imshow(correlation, text_auto=True, aspect="auto",
                              color_continuous_scale='RdBu_r')
                st.plotly_chart(fig, use_container_width=True)

# ==================== é¡µé¢3ï¼šæ¨¡å‹ç®¡ç† ====================

elif page == "ğŸ¤– æ¨¡å‹ç®¡ç†":
    st.title("ğŸ¤– æ¨¡å‹ç®¡ç†")
    
    tab1, tab2 = st.tabs(["ä»£ç†æ¨¡å‹", "å‡ ä½•ç¼–ç å™¨"])
    
    with tab1:
        st.subheader("ä»£ç†æ¨¡å‹ï¼ˆSurrogate Modelï¼‰")
        
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.markdown("""
            **å½“å‰çŠ¶æ€ï¼š** ğŸŸ¢ å·²è®­ç»ƒ
            
            **æ¨¡å‹ä¿¡æ¯ï¼š**
            - ç±»å‹: Random Forest Regressor
            - ç‰¹å¾ç»´åº¦: 6
            - è®­ç»ƒæ ·æœ¬: 150
            - å‡†ç¡®ç‡ RÂ²: 0.89
            - å¹³å‡è¯¯å·®: 15.3 MPa
            
            **æœ€åæ›´æ–°ï¼š** 2024-01-27 10:30
            """)
        
        with col2:
            if st.button("ğŸ”„ é‡æ–°è®­ç»ƒ", use_container_width=True):
                with st.spinner("è®­ç»ƒä¸­..."):
                    from ml.trainers.train_surrogate import train_surrogate_model
                    train_surrogate_model()
                st.success("è®­ç»ƒå®Œæˆï¼")
            
            if st.button("ğŸ“Š æŸ¥çœ‹è¯¦æƒ…", use_container_width=True):
                st.info("åŠŸèƒ½å¼€å‘ä¸­")
            
            if st.button("ğŸ’¾ å¯¼å‡ºæ¨¡å‹", use_container_width=True):
                st.info("åŠŸèƒ½å¼€å‘ä¸­")
        
        st.markdown("---")
        
        # å¿«é€Ÿé¢„æµ‹
        st.subheader("ğŸ¯ å¿«é€Ÿé¢„æµ‹")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            num_elements = st.number_input("ç½‘æ ¼å•å…ƒæ•°", value=50000, step=1000)
        
        with col2:
            clmax = st.number_input("æœ€å¤§ç½‘æ ¼å°ºå¯¸ (mm)", value=5.0, step=0.5)
        
        with col3:
            clmin = st.number_input("æœ€å°ç½‘æ ¼å°ºå¯¸ (mm)", value=0.5, step=0.1)
        
        if st.button("ğŸš€ é¢„æµ‹", use_container_width=True):
            # åŠ è½½æ¨¡å‹
            try:
                model = SurrogateModel()
                model.load('E:/DeepSeek_Work/ml/models/surrogate_stress.pkl')
                
                features = [num_elements, clmax, clmin, 100, 50, 10]  # ç¤ºä¾‹ç‰¹å¾
                prediction = model.predict(features)
                
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("é¢„æµ‹æœ€å¤§åº”åŠ›", f"{prediction['max_stress']:.2f} MPa")
                
                with col2:
                    st.metric("é¢„æµ‹å¹³å‡åº”åŠ›", f"{prediction['mean_stress']:.2f} MPa")
                
                with col3:
                    st.metric("ç½®ä¿¡åº¦", f"{prediction['confidence']:.1%}")
                
                if prediction['confidence'] > 0.85:
                    st.success("âœ… é«˜ç½®ä¿¡åº¦é¢„æµ‹ï¼Œå¯ç›´æ¥ä½¿ç”¨")
                else:
                    st.warning("âš ï¸ ç½®ä¿¡åº¦åä½ï¼Œå»ºè®®è¿è¡Œå®Œæ•´ä»¿çœŸ")
                
            except Exception as e:
                st.error(f"æ¨¡å‹åŠ è½½å¤±è´¥: {e}")
    
    with tab2:
        st.subheader("å‡ ä½•ç¼–ç å™¨")
        st.info("å‡ ä½•ç‰¹å¾æå–åŠŸèƒ½ - å¼€å‘ä¸­")

# ==================== é¡µé¢4ï¼šå¯è§†åŒ– ====================

elif page == "ğŸ¨ å¯è§†åŒ–":
    st.title("ğŸ¨ 3D å¯è§†åŒ–")
    
    # é€‰æ‹©ç»“æœæ–‡ä»¶
    result_file = st.text_input("ç»“æœæ–‡ä»¶è·¯å¾„", "E:/DeepSeek_Work/test/results/example.frd")
    
    col1, col2 = st.columns(2)
    
    with col1:
        viz_type = st.selectbox("å¯è§†åŒ–ç±»å‹", ["åº”åŠ›äº‘å›¾", "ä½ç§»äº‘å›¾", "æ—‹è½¬åŠ¨ç”»"])
    
    with col2:
        colormap = st.selectbox("é…è‰²æ–¹æ¡ˆ", ["jet", "viridis", "plasma", "coolwarm"])
    
    if st.button("ğŸ¨ ç”Ÿæˆå¯è§†åŒ–", use_container_width=True):
        with st.spinner("ç”Ÿæˆä¸­..."):
            try:
                from services.viz_service import VisualizationService
                
                viz = VisualizationService()
                output_dir = "E:/DeepSeek_Work/test/visualizations"
                
                if viz_type == "åº”åŠ›äº‘å›¾":
                    result = viz.visualize_stress(
                        result_file,
                        f"{output_dir}/stress.png",
                        options={'colormap': colormap}
                    )
                elif viz_type == "ä½ç§»äº‘å›¾":
                    result = viz.visualize_displacement(
                        result_file,
                        f"{output_dir}/displacement.png"
                    )
                else:
                    result = viz.create_animation(
                        result_file,
                        f"{output_dir}/rotation.gif"
                    )
                
                if result['success']:
                    st.success("âœ… ç”ŸæˆæˆåŠŸï¼")
                    st.image(result['output'])
                else:
                    st.error(f"ç”Ÿæˆå¤±è´¥: {result['error']}")
            
            except Exception as e:
                st.error(f"é”™è¯¯: {e}")
    
    st.markdown("---")
    
    # æ˜¾ç¤ºå†å²å¯è§†åŒ–
    st.subheader("ğŸ“‚ å†å²å¯è§†åŒ–")
    
    import os
    viz_dir = "E:/DeepSeek_Work/test/visualizations"
    
    if os.path.exists(viz_dir):
        images = [f for f in os.listdir(viz_dir) if f.endswith('.png')]
        
        if images:
            cols = st.columns(3)
            for i, img in enumerate(images[:6]):
                with cols[i % 3]:
                    st.image(os.path.join(viz_dir, img), caption=img, use_column_width=True)
        else:
            st.info("æš‚æ— å†å²å¯è§†åŒ–")
    else:
        st.info("å¯è§†åŒ–ç›®å½•ä¸å­˜åœ¨")

# ==================== é¡µé¢5ï¼šä»»åŠ¡ç®¡ç† ====================

elif page == "âš™ï¸ ä»»åŠ¡ç®¡ç†":
    st.title("âš™ï¸ ä»»åŠ¡ç®¡ç†")
    
    tab1, tab2, tab3 = st.tabs(["è¿è¡Œä¸­ä»»åŠ¡", "ä»»åŠ¡å†å²", "æ‰¹é‡æäº¤"])
    
    with tab1:
        st.subheader("ğŸ”„ è¿è¡Œä¸­çš„ä»»åŠ¡")
        
        # æ¨¡æ‹Ÿè¿è¡Œä¸­ä»»åŠ¡
        running_tasks = [
            {'ID': 'task_001', 'ç±»å‹': 'ç½‘æ ¼ç”Ÿæˆ', 'è¿›åº¦': 75, 'çŠ¶æ€': 'è¿è¡Œä¸­'},
            {'ID': 'task_002', 'ç±»å‹': 'åº”åŠ›åˆ†æ', 'è¿›åº¦': 30, 'çŠ¶æ€': 'è¿è¡Œä¸­'}
        ]
        
        for task in running_tasks:
            col1, col2, col3, col4 = st.columns([2, 2, 3, 1])
            
            with col1:
                st.text(task['ID'])
            
            with col2:
                st.text(task['ç±»å‹'])
            
            with col3:
                st.progress(task['è¿›åº¦'] / 100)
            
            with col4:
                if st.button("å–æ¶ˆ", key=task['ID']):
                    st.warning(f"å·²å–æ¶ˆ {task['ID']}")
    
    with tab2:
        st.subheader("ğŸ“‹ ä»»åŠ¡å†å²")
        
        history = [
            {'ID': 'task_099', 'ç±»å‹': 'åº”åŠ›åˆ†æ', 'å¼€å§‹æ—¶é—´': '10:30', 'è€—æ—¶': '5åˆ†é’Ÿ', 'çŠ¶æ€': 'âœ… å®Œæˆ'},
            {'ID': 'task_098', 'ç±»å‹': 'ç½‘æ ¼ç”Ÿæˆ', 'å¼€å§‹æ—¶é—´': '10:25', 'è€—æ—¶': '3åˆ†é’Ÿ', 'çŠ¶æ€': 'âœ… å®Œæˆ'},
            {'ID': 'task_097', 'ç±»å‹': 'çƒ­åˆ†æ', 'å¼€å§‹æ—¶é—´': '10:15', 'è€—æ—¶': '8åˆ†é’Ÿ', 'çŠ¶æ€': 'âœ… å®Œæˆ'}
        ]
        
        df_history = pd.DataFrame(history)
        st.dataframe(df_history, use_container_width=True, hide_index=True)
    
    with tab3:
        st.subheader("ğŸ“¦ æ‰¹é‡ä»»åŠ¡æäº¤")
        
        st.markdown("**å‚æ•°åŒ–ç ”ç©¶å·¥å…·**")
        
        col1, col2 = st.columns(2)
        
        with col1:
            param_name = st.text_input("å‚æ•°åç§°", "hole_diameter")
            param_start = st.number_input("èµ·å§‹å€¼", value=5.0)
            param_end = st.number_input("ç»“æŸå€¼", value=10.0)
        
        with col2:
            param_step = st.number_input("æ­¥é•¿", value=0.5)
            analysis_type = st.selectbox("åˆ†æç±»å‹", ["stress", "thermal", "modal"])
        
        if st.button("ğŸš€ æäº¤æ‰¹é‡ä»»åŠ¡", use_container_width=True):
            num_tasks = int((param_end - param_start) / param_step) + 1
            st.success(f"å·²æäº¤ {num_tasks} ä¸ªä»»åŠ¡åˆ°é˜Ÿåˆ—")
            st.info("ä»»åŠ¡å°†åœ¨åå°å¹¶è¡Œæ‰§è¡Œï¼Œå¯åœ¨'è¿è¡Œä¸­ä»»åŠ¡'æŸ¥çœ‹è¿›åº¦")


# dashboard/Dockerfile
"""
Dashboard Dockerfile
"""

FROM python:3.10-slim

WORKDIR /app

RUN pip install --no-cache-dir \
    streamlit \
    plotly \
    pandas \
    numpy \
    psycopg2-binary \
    redis

COPY . /app

CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]