# scripts/setup.sh
#!/bin/bash
# ä¸€é”®éƒ¨ç½²è„šæœ¬

echo "================================"
echo "CAE è‡ªåŠ¨åŒ–å¹³å° - ä¸€é”®éƒ¨ç½²"
echo "================================"

# æ£€æŸ¥ Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker Desktop"
    exit 1
fi

echo "âœ“ Docker å·²å®‰è£…"

# æ£€æŸ¥ Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose æœªå®‰è£…"
    exit 1
fi

echo "âœ“ Docker Compose å·²å®‰è£…"

# åˆ›å»ºç›®å½•ç»“æ„
echo ""
echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."

BASE_DIR="E:/DeepSeek_Work"

mkdir -p "$BASE_DIR/docker"
mkdir -p "$BASE_DIR/server"
mkdir -p "$BASE_DIR/ml/models"
mkdir -p "$BASE_DIR/ml/trainers"
mkdir -p "$BASE_DIR/ml/data"
mkdir -p "$BASE_DIR/dashboard/pages"
mkdir -p "$BASE_DIR/dashboard/components"
mkdir -p "$BASE_DIR/services"
mkdir -p "$BASE_DIR/config"
mkdir -p "$BASE_DIR/scripts"
mkdir -p "$BASE_DIR/test/input"
mkdir -p "$BASE_DIR/test/parts"
mkdir -p "$BASE_DIR/test/meshes"
mkdir -p "$BASE_DIR/test/analyses"
mkdir -p "$BASE_DIR/test/results"
mkdir -p "$BASE_DIR/test/visualizations"

echo "âœ“ ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

# æ„å»ºé•œåƒ
echo ""
echo "ğŸ³ æ„å»º Docker é•œåƒ..."

cd "$BASE_DIR/docker"

# æ„å»ºå„ä¸ªæœåŠ¡
docker-compose build

if [ $? -ne 0 ]; then
    echo "âŒ é•œåƒæ„å»ºå¤±è´¥"
    exit 1
fi

echo "âœ“ é•œåƒæ„å»ºå®Œæˆ"

# å¯åŠ¨æœåŠ¡
echo ""
echo "ğŸš€ å¯åŠ¨æœåŠ¡..."

docker-compose up -d

if [ $? -ne 0 ]; then
    echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
    exit 1
fi

echo "âœ“ æœåŠ¡å¯åŠ¨æˆåŠŸ"

# ç­‰å¾…æœåŠ¡å°±ç»ª
echo ""
echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo ""
echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."

docker-compose ps

# åˆå§‹åŒ–æ•°æ®åº“
echo ""
echo "ğŸ’¾ åˆå§‹åŒ–æ•°æ®åº“..."

python3 << EOF
import sys
sys.path.append('$BASE_DIR')
from server.data_collector import SimulationDataCollector

collector = SimulationDataCollector()
print("âœ“ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")
EOF

# æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
echo ""
echo "================================"
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "================================"
echo ""
echo "æœåŠ¡è®¿é—®åœ°å€ï¼š"
echo "  - æ•°å­—å­ªç”Ÿä»ªè¡¨ç›˜: http://localhost:8501"
echo "  - Celery ç›‘æ§ (Flower): http://localhost:5555"
echo "  - Redis: localhost:6379"
echo "  - PostgreSQL: localhost:5432"
echo ""
echo "åç»­æ­¥éª¤ï¼š"
echo "  1. å¯åŠ¨ MCP æœåŠ¡å™¨: python server/server.py"
echo "  2. é…ç½® Cherry Studio è¿æ¥åˆ° MCP"
echo "  3. è®¿é—®ä»ªè¡¨ç›˜æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€"
echo ""
echo "ç®¡ç†å‘½ä»¤ï¼š"
echo "  - æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f [æœåŠ¡å]"
echo "  - åœæ­¢æœåŠ¡: docker-compose down"
echo "  - é‡å¯æœåŠ¡: docker-compose restart"
echo ""


# scripts/start_all.sh
#!/bin/bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡

echo "ğŸš€ å¯åŠ¨ CAE è‡ªåŠ¨åŒ–å¹³å°..."

cd E:/DeepSeek_Work/docker

# å¯åŠ¨ Docker æœåŠ¡
docker-compose up -d

echo "âœ“ Docker æœåŠ¡å·²å¯åŠ¨"

# å¯åŠ¨ MCP æœåŠ¡å™¨ï¼ˆåå°ï¼‰
cd E:/DeepSeek_Work
nohup python server/server.py > server.log 2>&1 &

echo "âœ“ MCP æœåŠ¡å™¨å·²å¯åŠ¨"

echo ""
echo "æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨ï¼"
echo "è®¿é—® http://localhost:8501 æŸ¥çœ‹ä»ªè¡¨ç›˜"


# scripts/stop_all.sh
#!/bin/bash
# åœæ­¢æ‰€æœ‰æœåŠ¡

echo "ğŸ›‘ åœæ­¢ CAE è‡ªåŠ¨åŒ–å¹³å°..."

# åœæ­¢ MCP æœåŠ¡å™¨
pkill -f "python server/server.py"

echo "âœ“ MCP æœåŠ¡å™¨å·²åœæ­¢"

# åœæ­¢ Docker æœåŠ¡
cd E:/DeepSeek_Work/docker
docker-compose down

echo "âœ“ Docker æœåŠ¡å·²åœæ­¢"

echo ""
echo "æ‰€æœ‰æœåŠ¡å·²åœæ­¢"


# docker/gmsh.Dockerfile
"""
Gmsh æœåŠ¡ Dockerfile
"""

FROM python:3.10-slim

# é…ç½®é˜¿é‡Œäº‘é•œåƒ
RUN echo "deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free" > /etc/apt/sources.list

# å®‰è£… Gmsh
RUN apt-get update && apt-get install -y \
    gmsh \
    libgl1-mesa-glx \
    libglu1-mesa \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python åŒ…
RUN pip install --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple \
    numpy \
    gmsh

WORKDIR /app

ENV OMP_NUM_THREADS=4

CMD ["tail", "-f", "/dev/null"]


# docker/calculix.Dockerfile
"""
CalculiX æœåŠ¡ Dockerfile
"""

FROM python:3.10-slim

# é…ç½®é˜¿é‡Œäº‘é•œåƒ
RUN echo "deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free" > /etc/apt/sources.list

# å®‰è£… CalculiX
RUN apt-get update && apt-get install -y \
    calculix-ccx \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

ENV OMP_NUM_THREADS=8

CMD ["tail", "-f", "/dev/null"]


# docker/ml.Dockerfile
"""
ML æœåŠ¡ Dockerfile
"""

FROM python:3.10

# å®‰è£… PyTorch å’Œ ML åº“
RUN pip install --no-cache-dir \
    torch torchvision --index-url https://download.pytorch.org/whl/cpu \
    scikit-learn \
    joblib \
    faiss-cpu \
    numpy \
    pandas

# å¯é€‰ï¼šå¦‚æœæœ‰ GPU
# RUN pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118

WORKDIR /app

CMD ["tail", "-f", "/dev/null"]


# docker/server.Dockerfile
"""
Server/Celery Dockerfile
"""

FROM python:3.10-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
RUN apt-get update && apt-get install -y \
    docker.io \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python åŒ…
RUN pip install --no-cache-dir \
    celery[redis] \
    flower \
    psycopg2-binary \
    sqlalchemy \
    numpy \
    pandas

COPY . /app

CMD ["celery", "-A", "tasks", "worker", "--loglevel=info"]


# scripts/backup.sh
#!/bin/bash
# æ•°æ®å¤‡ä»½è„šæœ¬

echo "ğŸ’¾ å¼€å§‹å¤‡ä»½..."

BACKUP_DIR="E:/DeepSeek_Work/backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ•°æ®åº“
echo "å¤‡ä»½æ•°æ®åº“..."
docker exec cae_postgres pg_dump -U cae_user cae_platform > "$BACKUP_DIR/database.sql"

# å¤‡ä»½ä»¿çœŸå†å²
echo "å¤‡ä»½ä»¿çœŸå†å²..."
cp E:/DeepSeek_Work/ml/data/simulation_history.db "$BACKUP_DIR/"

# å¤‡ä»½æ¨¡å‹
echo "å¤‡ä»½æ¨¡å‹..."
cp -r E:/DeepSeek_Work/ml/models/*.pkl "$BACKUP_DIR/" 2>/dev/null

# å¤‡ä»½é…ç½®
echo "å¤‡ä»½é…ç½®..."
cp -r E:/DeepSeek_Work/config "$BACKUP_DIR/"

echo "âœ“ å¤‡ä»½å®Œæˆ: $BACKUP_DIR"


# scripts/health_check.sh
#!/bin/bash
# å¥åº·æ£€æŸ¥è„šæœ¬

echo "ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥..."

# æ£€æŸ¥ Docker æœåŠ¡
echo ""
echo "æ£€æŸ¥ Docker æœåŠ¡:"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

# æ£€æŸ¥ Redis
echo ""
echo "æ£€æŸ¥ Redis:"
docker exec cae_redis redis-cli ping

# æ£€æŸ¥ PostgreSQL
echo ""
echo "æ£€æŸ¥ PostgreSQL:"
docker exec cae_postgres pg_isready -U cae_user

# æ£€æŸ¥ Celery Worker
echo ""
echo "æ£€æŸ¥ Celery Worker:"
docker exec cae_celery_worker celery -A tasks inspect active

# æ£€æŸ¥ç£ç›˜ç©ºé—´
echo ""
echo "æ£€æŸ¥ç£ç›˜ç©ºé—´:"
df -h E:/DeepSeek_Work

echo ""
echo "âœ“ å¥åº·æ£€æŸ¥å®Œæˆ"


# scripts/update_system.sh
#!/bin/bash
# ç³»ç»Ÿæ›´æ–°è„šæœ¬

echo "ğŸ”„ æ›´æ–°ç³»ç»Ÿ..."

cd E:/DeepSeek_Work

# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨ Gitï¼‰
# git pull

# é‡å»ºé•œåƒ
echo "é‡å»º Docker é•œåƒ..."
cd docker
docker-compose build --no-cache

# é‡å¯æœåŠ¡
echo "é‡å¯æœåŠ¡..."
docker-compose down
docker-compose up -d

# æ›´æ–° Python ä¾èµ–
echo "æ›´æ–° Python ä¾èµ–..."
pip install --upgrade -r requirements.txt

echo "âœ“ æ›´æ–°å®Œæˆ"


# requirements.txt
"""
Python ä¾èµ–åŒ…åˆ—è¡¨
"""

# æ ¸å¿ƒæ¡†æ¶
celery[redis]==5.3.4
flower==2.0.1
streamlit==1.29.0

# æ•°æ®åº“
psycopg2-binary==2.9.9
sqlalchemy==2.0.23
redis==5.0.1

# æœºå™¨å­¦ä¹ 
torch==2.1.2
scikit-learn==1.3.2
joblib==1.3.2
faiss-cpu==1.7.4

# å¯è§†åŒ–
pyvista==0.43.1
plotly==5.18.0
matplotlib==3.8.2

# æ•°æ®å¤„ç†
numpy==1.26.2
pandas==2.1.4

# CAD/CAE
cadquery==2.4.0
gmsh

# å·¥å…·
tqdm==4.66.1
Pillow==10.1.0
imageio==2.33.1