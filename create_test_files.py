"""
åˆ›å»ºç¤ºä¾‹å‡ ä½•æ–‡ä»¶
è¿è¡Œæ­¤è„šæœ¬æ¥ç”Ÿæˆæµ‹è¯•æ•°æ®
"""

from pathlib import Path
import json

# åˆ›å»ºç›®å½•
input_dir = Path("E:/DeepSeek_Work/test/input")
input_dir.mkdir(parents=True, exist_ok=True)

meshes_dir = Path("E:/DeepSeek_Work/test/meshes")
meshes_dir.mkdir(parents=True, exist_ok=True)

analyses_dir = Path("E:/DeepSeek_Work/test/analyses")
analyses_dir.mkdir(parents=True, exist_ok=True)

results_dir = Path("E:/DeepSeek_Work/test/results")
results_dir.mkdir(parents=True, exist_ok=True)

print("âœ… ç›®å½•åˆ›å»ºå®Œæˆ")

# 1. åˆ›å»ºç®€å•çš„ CalculiX è¾“å…¥æ–‡ä»¶ï¼ˆç”¨äºæµ‹è¯•ï¼‰
inp_file = analyses_dir / "test_cube.inp"

inp_content = """
** æµ‹è¯•ç«‹æ–¹ä½“ - CalculiX è¾“å…¥æ–‡ä»¶
** è‡ªåŠ¨ç”Ÿæˆ

*HEADING
Test Cube Stress Analysis

** Generated by CAE Platform

*NODE, FILE=CUBE-NODES, NSET=NALL
1,0.0,0.0,0.0
2,10.0,0.0,0.0
3,10.0,10.0,0.0
4,0.0,10.0,0.0
5,0.0,0.0,10.0
6,10.0,0.0,10.0
7,10.0,10.0,10.0
8,0.0,10.0,10.0

*ELEMENT, TYPE=C3D8, ELSET=EALL
1,1,2,4,5,2,3,7,6
2,2,3,4,6,3,4,8,7

*MATERIAL, NAME=STEEL
*ELASTIC
210000.,0.3
*DENSITY
7.85E-9

*BOUNDARY
NSET,FIXED,1,1,3
1,2,5,6

*DLOAD
OP_NEW,SF,P1,1,3.0

*STEP, NLGEOM=NO, INC=10000
*STATIC
1.,1.,1E-07,1E-07

*NODE FILE, NSET=NALL
*EL FILE, ELSET=EALL
*EL PRINT, ELSET=EALL, FREQ=1
*NODE PRINT, NSET=NALL, FREQ=1
*END STEP
*END
"""

inp_file.write_text(inp_content)
print(f"âœ… CalculiX è¾“å…¥æ–‡ä»¶å·²åˆ›å»º: {inp_file}")

# 2. åˆ›å»ºä»»åŠ¡é…ç½®æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
task_config = {
    "task_id": "task_001",
    "task_type": "stress",
    "geometry_file": "/app/test/input/test_cube.step",
    "mesh_file": "/app/test/meshes/test_cube.msh",
    "input_file": "/app/test/analyses/test_cube.inp",
    "output_file": "/app/test/results/test_cube.frd",
    "mesh_params": {
        "clmax": 2.0,
        "clmin": 0.5,
        "algorithm": "delaunay"
    },
    "material": {
        "elastic_modulus": 210000,
        "poisson_ratio": 0.3,
        "density": 7.85E-9
    },
    "boundary_conditions": {
        "fixed_nodes": [1, 2, 5, 6],
        "load": {
            "type": "pressure",
            "value": 3.0,
            "face": "SURFACE1"
        }
    }
}

config_file = input_dir / "task_config.json"
with open(config_file, 'w', encoding='utf-8') as f:
    json.dump(task_config, f, indent=2, ensure_ascii=False)

print(f"âœ… ä»»åŠ¡é…ç½®æ–‡ä»¶å·²åˆ›å»º: {config_file}")

# 3. åˆ›å»ºç®€å•çš„è¯´æ˜æ–‡ä»¶
readme_file = input_dir / "README.txt"
readme_content = """
# æµ‹è¯•æ–‡ä»¶è¯´æ˜

## æ–‡ä»¶åˆ—è¡¨

1. test_cube.inp - CalculiX è¾“å…¥æ–‡ä»¶ï¼ˆç«‹æ–¹ä½“ï¼‰
   - 8 ä¸ªèŠ‚ç‚¹
   - 1 ä¸ªå•å…ƒï¼ˆå…­é¢ä½“ï¼‰
   - ææ–™ï¼šé’¢æ
   - è¾¹ç•Œï¼šåº•éƒ¨å›ºå®šï¼Œé¡¶éƒ¨åŠ è½½

2. task_config.json - ä»»åŠ¡é…ç½®ç¤ºä¾‹
   - åŒ…å«ç½‘æ ¼å‚æ•°
   - ææ–™å±æ€§
   - è¾¹ç•Œæ¡ä»¶

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1ï¼šç›´æ¥è¿è¡Œä»¿çœŸï¼ˆå‘½ä»¤è¡Œï¼‰

```bash
# è¿›å…¥ CalculiX å®¹å™¨
docker exec -it cae_calculix bash

# è¿è¡Œä»¿çœŸ
cd /app/test/analyses
ccx -i test_cube

# æŸ¥çœ‹ç»“æœ
cat test_cube.out
```

### æ–¹æ³• 2ï¼šé€šè¿‡ Dashboard æäº¤ä»»åŠ¡

1. è®¿é—® http://localhost:8501
2. è¿›å…¥"ä»»åŠ¡ç®¡ç†"é¡µé¢
3. å¡«å†™ä»»åŠ¡è¡¨å•ï¼š
   - ä»»åŠ¡ç±»å‹ï¼šåº”åŠ›åˆ†æ
   - è¾“å…¥æ–‡ä»¶ï¼š/app/test/analyses/test_cube.inp
   - ç½‘æ ¼å‚æ•°ï¼šä½¿ç”¨é»˜è®¤å€¼
   - æäº¤ä»»åŠ¡

### æ–¹æ³• 3ï¼šé€šè¿‡ API æäº¤ä»»åŠ¡ï¼ˆå¦‚æœæœ‰ APIï¼‰

```python
import requests

# æäº¤ä»»åŠ¡
response = requests.post(
    "http://localhost:8000/api/v1/tasks",
    json={
        "task_type": "stress",
        "input_file": "/app/test/analyses/test_cube.inp",
        "parameters": {...}
    }
)

task_id = response.json()["task_id"]
print(f"ä»»åŠ¡ ID: {task_id}")
```

## é¢„æœŸç»“æœ

- èŠ‚ç‚¹æ•°ï¼š8
- å•å…ƒæ•°ï¼š1
- æœ€å¤§åº”åŠ›ï¼šçº¦ 3.0 MPa
- æœ€å¤§ä½ç§»ï¼šçº¦ 0.0015 mm
- è®¡ç®—æ—¶é—´ï¼š< 1 ç§’

## æŸ¥çœ‹ç»“æœ

ç»“æœæ–‡ä»¶ä½ç½®ï¼š
- test_cube.dat - æ•°å€¼ç»“æœ
- test_cube.frd - FRD æ ¼å¼ç»“æœï¼ˆç”¨äºå¯è§†åŒ–ï¼‰

å¯è§†åŒ–æ–¹æ³•ï¼š
1. åœ¨ Dashboard çš„"å¯è§†åŒ–"é¡µé¢
2. è¾“å…¥ç»“æœæ–‡ä»¶è·¯å¾„
3. é€‰æ‹©å¯è§†åŒ–ç±»å‹
4. ç”Ÿæˆäº‘å›¾

## æ•…éšœæ’é™¤

å¦‚æœä»»åŠ¡å¤±è´¥ï¼š

1. æ£€æŸ¥æ–‡ä»¶æƒé™
```bash
docker exec -it cae_dashboard ls -la /app/test/analyses/
```

2. æ£€æŸ¥ CalculiX æ—¥å¿—
```bash
docker logs cae_calculix --tail 50
```

3. æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
```bash
# è®¿é—® Flower
http://localhost:5555
```

4. æŸ¥çœ‹ Celery Worker æ—¥å¿—
```bash
docker logs cae_celery_worker --tail 50
```

## ä¸‹ä¸€æ­¥

1. ç†Ÿæ‚‰ä»»åŠ¡æäº¤æµç¨‹
2. å°è¯•ä¸åŒçš„å‚æ•°
3. ä¸Šä¼ è‡ªå·±çš„å‡ ä½•æ–‡ä»¶
4. æ¢ç´¢å¯è§†åŒ–åŠŸèƒ½
5. åˆ†æç»“æœæ•°æ®

---

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒ OPERATION_GUIDE.md
"""

readme_file.write_text(readme_content)
print(f"âœ… è¯´æ˜æ–‡ä»¶å·²åˆ›å»º: {readme_file}")

print("\nğŸ‰ æµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆï¼")
print(f"\nğŸ“ æ–‡ä»¶ä½ç½®:")
print(f"  è¾“å…¥: {input_dir}")
print(f"  ç½‘æ ¼: {meshes_dir}")
print(f"  åˆ†æ: {analyses_dir}")
print(f"  ç»“æœ: {results_dir}")
print(f"\nğŸ“– è¯´æ˜æ–‡ä»¶: {readme_file}")
print(f"\nğŸš€ ä¸‹ä¸€æ­¥: æŸ¥çœ‹ OPERATION_GUIDE.md äº†è§£å¦‚ä½•å¼€å§‹ç¬¬ä¸€ä¸ªä»»åŠ¡")
