# CAE Digital Twin Platform - 完整操作指南

## 📋 目录
1. [快速检查](#1-快速检查)
2. [开始第一个任务](#2-开始第一个任务)
3. [任务类型说明](#3-任务类型说明)
4. [Dashboard 使用指南](#4-dashboard-使用指南)
5. [监控和调试](#5-监控和调试)

---

## 1. 快速检查

### 1.1 确认服务状态

打开浏览器访问：
- **Dashboard**: http://localhost:8501
- **Flower**: http://localhost:5555

或者使用命令行检查：
```bash
# 检查所有容器
docker ps --filter "name=cae_"

# 查看特定服务日志
docker logs cae_dashboard --tail 20
docker logs cae_celery_worker --tail 20
```

### 1.2 确认目录结构

确保以下目录存在并有文件：
```
E:\DeepSeek_Work\
├── test/
│   ├── input/          # 几何文件（.step, .stp）
│   ├── meshes/         # 网格文件（.msh）
│   ├── analyses/        # 仿真输入文件（.inp）
│   └── results/         # 仿真结果（.frd, .dat）
├── ml/
│   └── data/          # 训练数据
└── server/
    └── data_collector.py  # 数据采集
```

---

## 2. 开始第一个任务

### 🎯 方案 A：使用 Dashboard（推荐）

#### 步骤 1：准备几何文件

1. **创建或准备几何文件**
   - 格式：STEP (.step, .stp)
   - 位置：`E:\DeepSeek_Work\test\input\`
   - 示例文件名：`model.step`

2. **如果没有几何文件，可以创建简单的示例**
   ```python
   # 创建一个简单的立方体几何
   from cadquery import Workplane

   cube = Workplane("XY").box(10, 10, 10)
   cube.val().exportStep("E:/DeepSeek_Work/test/input/cube.step")
   ```

#### 步骤 2：提交网格生成任务

1. **访问 Dashboard**: http://localhost:8501

2. **进入"任务管理"页面**
   - 点击侧边栏的"⚙️ 任务管理"

3. **填写任务表单**
   - 任务类型：网格生成
   - 几何文件：选择或输入文件路径
     - 例如：`/app/test/input/cube.step`（Docker 内路径）
   - 网格参数：
     - 最大网格尺寸：5.0
     - 最小网格尺寸：0.5
     - 单元类型：tetra（四面体）或 hexa（六面体）

4. **提交任务**
   - 点击"🚀 提交任务"按钮
   - 等待任务进入队列

#### 步骤 3：查看任务进度

1. **在 Flower 中监控**
   - 访问：http://localhost:5555
   - 查看任务状态：PENDING -> STARTED -> SUCCESS/FAILURE

2. **在 Dashboard 中查看**
   - 点击"📊 实时监控"
   - 查看"运行中任务"部分
   - 进度条会显示任务进度

#### 步骤 4：提交仿真任务

1. **网格生成完成后**
   - 网格文件会保存到：`E:\DeepSeek_Work\test\meshes\`
   - 文件名：例如 `cube.msh`

2. **提交仿真任务**
   - 返回"任务管理"页面
   - 任务类型：应力分析
   - 选择网格文件
   - 设置材料参数：
     - 弹性模量：210000 MPa（钢材）
     - 泊松比：0.3
     - 密度：7.85e-9 kg/mm³
   - 设置边界条件：
     - 固定边界：选择要固定的面
     - 加载：施加力或压力

3. **提交任务并等待完成**

#### 步骤 5：查看结果

1. **结果文件位置**
   - `E:\DeepSeek_Work\test\results\`
   - 文件类型：
     - `.frd` - CalculiX 结果文件
     - `.dat` - 仿真数据
     - `.cvg` - 收敛性

2. **在 Dashboard 中可视化**
   - 点击"🎨 可视化"
   - 输入结果文件路径：`/app/test/results/model.frd`
   - 选择可视化类型：应力云图、位移云图
   - 点击"🎨 生成可视化"

3. **分析数据**
   - 点击"📈 数据分析"
   - 查看统计信息
   - 生成图表和报告

---

### 🖥️ 方案 B：使用命令行（高级用户）

#### 步骤 1：生成网格

```bash
# 进入 Gmsh 容器
docker exec -it cae_gmsh bash

# 运行 Gmsh 生成网格
gmsh /app/test/input/cube.step -2 \
  -o /app/test/meshes/cube.msh \
  -clmax 5.0 \
  -clmin 0.5 \
  -order 2
```

参数说明：
- `-2`：2D 网格（3D 用 `-3`）
- `-o`：输出文件路径
- `-clmax`：最大网格尺寸
- `-clmin`：最小网格尺寸
- `-order`：单元阶数（1 或 2）

#### 步骤 2：准备仿真输入文件

```bash
# 创建 CalculiX 输入文件
cat > /app/test/analyses/cube.inp << 'EOF'
*HEADING
Cube Stress Analysis

** Generated by CAE Platform

*NODE, FILE=CUBE-NODES, SYSTEM=1, NSET=NALL
$ 1.0, 0.0, 0.0
 2.0, 10.0, 0.0
... (继续添加节点)

*ELEMENT, TYPE=C3D8, ELSET=EALL
... (添加单元)

*MATERIAL, NAME=STEEL
*ELASTIC
210000.,0.3
*DENSITY
7.85E-9

*BOUNDARY
NSET,FIXED,1,1,3
... (设置边界条件)

*STEP, NLGEOM=NO, INC=10000
*STATIC
1.,1.,1E-07,1E-07

*DLOAD
... (施加载荷)

*NODE FILE, NSET=NALL
*EL FILE, ELSET=EALL
*EL PRINT, ELSET=EALL, FREQ=1
*NODE PRINT, NSET=NALL, FREQ=1
*END STEP
*END
EOF
```

#### 步骤 3：运行仿真

```bash
# 进入 CalculiX 容器
docker exec -it cae_calculix bash

# 运行 CalculiX
ccx -i /app/test/analyses/cube

# 查看输出
cat /app/test/analyses/cube.out
```

#### 步骤 4：检查结果

```bash
# 查看结果文件
ls -la /app/test/results/

# 解析 .frd 文件（如果需要）
# 可以使用 Python 或自定义工具
```

---

## 3. 任务类型说明

### 3.1 网格生成任务

**目的**：将几何模型离散化为有限元网格

**输入**：
- 几何文件（STEP, STL, IGES）
- 网格参数（尺寸、类型）

**输出**：
- 网格文件（.msh）
- 节点和单元信息

**参数**：
```python
{
    "geometry_file": "/app/test/input/model.step",
    "mesh_type": "tetra",  # tetra 或 hexa
    "clmax": 5.0,         # 最大尺寸
    "clmin": 0.5,         # 最小尺寸
    "order": 2,            # 单元阶数
    "algorithm": "delaunay"  # 算法
}
```

### 3.2 应力分析任务

**目的**：计算结构在载荷作用下的应力分布

**输入**：
- 网格文件（.msh）
- 材料属性
- 边界条件
- 载荷

**输出**：
- 应力云图（.frd）
- 位移云图（.frd）
- 数值结果（.dat）

**参数**：
```python
{
    "mesh_file": "/app/test/meshes/model.msh",
    "material": {
        "elastic_modulus": 210000,  # MPa
        "poisson_ratio": 0.3,
        "density": 7.85E-9       # kg/mm³
    },
    "boundary_conditions": {
        "fixed_nodes": [1, 2, 3],
        "prescribed_displacements": []
    },
    "loads": [
        {
            "type": "pressure",
            "value": 10,  # MPa
            "surface": "SURFACE1"
        }
    ]
}
```

### 3.3 热分析任务

**目的**：计算温度场分布

**输入**：
- 网格文件
- 热属性
- 边界条件（温度、热流）

**输出**：
- 温度云图
- 热流分布

### 3.4 模态分析任务

**目的**：计算结构的固有频率和模态形状

**输入**：
- 网格文件
- 材料属性
- 频率范围

**输出**：
- 固有频率
- 模态振型

---

## 4. Dashboard 使用指南

### 4.1 实时监控页面

**功能**：
- 查看系统整体状态
- 统计仿真数据
- 监控任务队列

**指标**：
- 总仿真数
- 成功率
- 平均耗时
- 运行中任务

### 4.2 数据分析页面

**功能**：
- 选择分析类型（应力、热、模态）
- 查看统计信息
- 生成图表和报告
- 导出数据

**图表**：
- 应力分布直方图
- 散点矩阵
- 相关性分析
- 时间序列趋势

### 4.3 模型管理页面

**功能**：
- 训练代理模型（Surrogate Model）
- 查看模型性能
- 快速预测
- 导出模型

**预测**：
- 输入网格参数
- 获得快速应力预测
- 查看置信度

### 4.4 可视化页面

**功能**：
- 选择结果文件
- 选择可视化类型
- 调整显示选项
- 导出图片/视频

**可视化类型**：
- 应力云图
- 位移云图
- 温度云图
- 模态振型
- 旋转动画

### 4.5 任务管理页面

**功能**：
- 查看运行中任务
- 查看任务历史
- 批量任务提交
- 参数化研究

**批量提交**：
- 设置参数范围
- 选择分析类型
- 自动生成多个任务

---

## 5. 监控和调试

### 5.1 查看日志

```bash
# Dashboard 日志
docker logs cae_dashboard -f

# Celery Worker 日志
docker logs cae_celery_worker -f

# Gmsh 日志
docker logs cae_gmsh -f

# CalculiX 日志
docker logs cae_calculix -f

# 所有服务日志
docker-compose -f docker/docker-compose.yml logs -f
```

### 5.2 Flower 监控

访问 http://localhost:5555

**可查看的信息**：
- Worker 状态
- 任务队列
- 任务执行历史
- 任务详情
- 成功/失败统计

### 5.3 数据库检查

```bash
# 进入 PostgreSQL
docker exec -it cae_postgres psql -U cae_user -d cae_platform

# 查看表
\dt

# 查看仿真记录
SELECT * FROM simulations ORDER BY timestamp DESC LIMIT 10;

# 退出
\q
```

### 5.4 常见问题排查

#### 问题 1：任务卡在 PENDING 状态

**原因**：Celery worker 未运行或连接问题

**解决**：
```bash
# 检查 worker 状态
docker ps | grep celery

# 重启 worker
docker restart cae_celery_worker

# 检查 Redis 连接
docker exec -it cae_redis redis-cli
> PING
# 应该返回 PONG
```

#### 问题 2：任务执行失败

**原因**：输入文件错误或参数问题

**解决**：
```bash
# 查看详细错误
docker logs cae_celery_worker --tail 100

# 检查输入文件
docker exec -it cae_dashboard ls -la /app/test/input/

# 验证文件格式
file /app/test/input/cube.step
```

#### 问题 3：Dashboard 无法访问

**原因**：端口冲突或服务未启动

**解决**：
```bash
# 检查端口占用
netstat -ano | findstr :8501

# 重启 Dashboard
docker restart cae_dashboard

# 查看日志
docker logs cae_dashboard
```

#### 问题 4：数据库连接失败

**原因**：数据库未初始化或权限问题

**解决**：
```bash
# 检查数据库目录
docker exec -it cae_dashboard ls -la /data/

# 创建目录（如果不存在）
docker exec -it cae_dashboard mkdir -p /data/

# 重启服务
docker restart cae_dashboard
```

---

## 6. 最佳实践

### 6.1 任务提交建议

1. **从小规模开始**
   - 先用简单的几何测试
   - 验证流程无误
   - 逐步增加复杂度

2. **合理设置参数**
   - 网格尺寸：不要过小（导致单元数过多）
   - 载荷步长：选择合适的增量
   - 收敛准则：平衡精度和速度

3. **定期清理**
   - 删除临时文件
   - 归档旧结果
   - 清理数据库

### 6.2 性能优化

1. **网格优化**
   - 在应力集中区域加密网格
   - 在均匀区域使用粗网格
   - 使用高阶单元（order=2）

2. **并行计算**
   - 设置合适的 OMP_NUM_THREADS
   - 调整 Celery worker 并发数
   - 使用多节点计算（如果可用）

3. **缓存利用**
   - 重用已有的网格
   - 复用材料模型
   - 使用代理模型快速预测

### 6.3 安全考虑

1. **输入验证**
   - 检查文件格式
   - 验证参数范围
   - 限制文件大小

2. **访问控制**
   - 使用 Flower 认证
   - 限制 Dashboard 访问
   - 保护敏感数据

3. **备份策略**
   - 定期备份数据库
   - 归档重要结果
   - 版本控制配置文件

---

## 7. 下一步

### 7.1 扩展功能

- 集成更多仿真求解器（Abaqus, ANSYS）
- 添加更多可视化选项
- 实现参数优化算法
- 开发自动化工作流

### 7.2 性能提升

- 使用 GPU 加速计算
- 分布式计算
- 结果缓存机制
- 增量更新策略

### 7.3 用户体验

- 更好的任务管理界面
- 实时通知功能
- 移动端适配
- 报告模板

---

## 📞 获取帮助

如果遇到问题：

1. **查看文档**
   - README.md
   - USER_GUIDE.md
   - 本指南

2. **检查日志**
   - Docker 容器日志
   - Flower 监控
   - 数据库记录

3. **创建 Issue**
   - GitHub 仓库
   - 详细描述问题
   - 提供错误信息和日志

---

**祝你使用愉快！** 🎉
